<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ReadNest - Online Book Store</title>
<script src="https://cdn.tailwindcss.com"></script>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
<style>
  @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

  * {
    font-family: "Poppins", sans-serif;
  }

  .book-card:hover {
    transform: translateY(-5px);
    transition: transform 0.3s ease;
  }

  .filter-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
  }

  .rating-badge {
    background: #22c55e;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }

  .banner-special {
    background: linear-gradient(135deg, #7c2d12 0%, #991b1b 100%);
  }
</style>

<body class="bg-gray-100">
  <%- include("../../views/partials/user/header") %>
  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex gap-6">
      <!-- Sidebar Filters -->
      <aside class="w-64 flex-shrink-0">
        <div class="bg-white rounded-lg shadow-sm p-6 filter-sidebar">
          <h2 class="text-xl font-bold mb-6">Filters</h2>

          <!-- Categories -->
          <div class="mb-6">
            <h3 class="font-semibold text-gray-800 mb-3">CATEGORIES</h3>

            <ul class="space-y-2">
              <li
                class="flex justify-between items-center cursor-pointer <%= !selectedCategory ? 'text-orange-600 font-semibold' : 'hover:text-orange-600' %>"
              >
                <a href="/">
                  <span class="text-sm">All Books</span>
                </a>
              </li>
              <% categories.forEach(category => { %>

              <li>
                <a
                  href="/?category=<%= category.categoryName %><%= baseQuery ? '&' + baseQuery : '' %>"
                  class="flex justify-between items-center cursor-pointer <%= selectedCategory == category.categoryName ? 'text-orange-600 font-semibold' : 'hover:text-orange-600' %>"
                >
                  <span class="text-sm"><%= category.categoryName %></span>
                  <i class="fas fa-chevron-right text-xs"></i>
                </a>
              </li>

              <% }) %>
            </ul>
          </div>

          <!-- Price Range -->
          <div class="mb-6">
            <h3 class="font-semibold text-gray-800 mb-3">PRICE</h3>

            <form action="/" method="GET" class="space-y-3">
              <% if (selectedCategory) { %>
              <input
                type="hidden"
                name="category"
                value="<%= selectedCategory %>"
              />
              <% } %> <% selectedLanguages.forEach(lang => { %>
              <input type="hidden" name="languages" value="<%= lang %>" />
              <% }); %>

              <!-- Keep old min/max if present -->
              <% if (min) { %>
              <input type="hidden" name="min" value="<%= min %>" />
              <% } %> <% if (max) { %>
              <input type="hidden" name="max" value="<%= max %>" />
              <% } %>

              <!-- Price Inputs -->
              <div class="flex items-center space-x-3">
                <input
                  type="number"
                  name="min"
                  placeholder="Min"
                  value="<%= min || '' %>"
                  class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                />

                <span class="text-gray-500">to</span>

                <input
                  type="number"
                  name="max"
                  placeholder="Max"
                  value="<%= max || '' %>"
                  class="w-20 px-3 py-2 border border-gray-300 rounded-lg rounded text-sm"
                />
              </div>

              <!-- Button on Next Line -->
              <button
                type="submit"
                class="w-full px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition"
              >
                Apply Filter
              </button>
            </form>
          </div>

          <!-- Offers -->
          <div class="mb-6">
            <h3 class="font-semibold text-gray-800 mb-3">OFFERS</h3>
            <ul class="space-y-2">
              <li
                class="flex justify-between items-center cursor-pointer hover:text-orange-600"
              >
                <span class="text-sm">Combo Offers</span>
                <i class="fas fa-chevron-right text-xs"></i>
              </li>
              <li
                class="flex justify-between items-center cursor-pointer hover:text-orange-600"
              >
                <span class="text-sm">Rush Hour</span>
                <i class="fas fa-chevron-right text-xs"></i>
              </li>
            </ul>
          </div>

          <!-- Languages -->
          <div class="mb-6">
            <h3 class="font-semibold text-gray-800 mb-3">LANGUAGES</h3>
            <form action="/" method="GET" id="languageForm" class="space-y-2">
              <% if (selectedCategory) { %>
              <input
                type="hidden"
                name="category"
                value="<%= selectedCategory %>"
              />
              <% } %> <% if (min) { %>
              <input type="hidden" name="min" value="<%= min %>" />
              <% } %> <% if (max) { %>
              <input type="hidden" name="max" value="<%= max %>" />
              <% } %> <% languages.forEach(lang => { %>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="languages" class="w-4 h-4
                lang-check" value="<%= lang %>" <%=
                selectedLanguages.includes(lang) ? "checked" : "" %> />
                <span class="text-sm"><%= lang %></span>
              </label>
              <% }) %>

              <input type="hidden" name="languages" id="languagesInput" />

              <button
                type="submit"
                class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 w-full mt-2"
              >
                Apply
              </button>
            </form>
          </div>

          <!-- You Clubs -->
          <div>
            <div
              class="flex justify-between items-center cursor-pointer hover:text-orange-600"
            >
              <h3 class="font-semibold text-gray-800">YOU CLUBS</h3>
              <i class="fas fa-chevron-right text-xs"></i>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
          <div class="grid grid-cols-4 gap-6">
            <% products.forEach((product, index) => { %>

            <!-- Insert Banner After 2 Rows (2 × 4 = 8 items) -->
            <% if (index === 8) { %>
          </div>
          <!-- close grid -->

          <!-- Special Banner -->
          <div
            class="banner-special rounded-lg p-8 mb-6 text-white relative overflow-hidden"
          >
            <%- include("../../views/partials/admin/banner") %>
          </div>

          <div class="grid grid-cols-4 gap-6">
            <% } %>

            <!-- Dynamic Book Card -->
            <a
              href="/product?id=<%= product._id %><%= baseQuery ? '&' + baseQuery : '' %>"
              class="block group"
            >
              <div
                class="relative w-full h-72 bg-gray-100 rounded-xl overflow-hidden shadow-sm"
              >
                <% if (product.productImage && product.productImage.length > 0)
                { %>
                <img
                  src="<%= product.productImage[0] %>"
                  class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
                  alt="<%= product.productName %>"
                />
                <% } else { %>
                <div
                  class="w-full h-full bg-gradient-to-br from-gray-300 to-gray-500"
                ></div>
                <% } %>

                <!-- Title Overlay -->
                <div
                  class="absolute bottom-0 left-0 right-0 bg-black/60 text-white py-2 px-3"
                >
                  <p class="text-sm font-semibold truncate">
                    <%= product.productName %>
                  </p>
                </div>
              </div>

              <!-- Below-card text -->
              <h3 class="font-semibold text-sm mt-2 truncate">
                <%= product.productName %>
              </h3>

              <div class="flex items-center">
                <span class="rating-badge"
                  ><%= product.rating || "4.5" %> ★</span
                >
              </div>

              <p class="text-lg font-bold text-gray-800">
                ₹<%= product.regularPrice %>
              </p>
            </a>

            <% }) %>
          </div>
        </div>

        <div
          class="flex justify-end items-center gap-2 p-6 border-t border-gray-200"
        >
          <nav aria-label="Page navigation">
            <ul class="flex items-center gap-2">
              <% for(let i = 1; i <= totalPages; i++) { %>
              <li>
                <a
                  class="px-4 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 transition <%= (i === currentPage) ? 'bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-700' : 'bg-white hover:bg-gray-100' %>"
                  href="?page=<%= i %><%= baseQuery ? '&' + baseQuery : '' %>"
                >
                  <%= i %>
                </a>
              </li>
              <% } %>
            </ul>
          </nav>
        </div>
      </main>
    </div>
  </div>

  <%- include("../../views/partials/user/footer") %>
</body>

<script>
  const form = document.getElementById("languageForm");
  const hiddenInput = document.getElementById("languagesInput");

  form.addEventListener("submit", (e) => {
    const selected = [...document.querySelectorAll(".lang-check:checked")].map(
      (cb) => cb.value
    );

    if (selected.length > 0) {
      hiddenInput.value = selected.join(",");
    } else {
      // If no language selected → remove hiddenInput so URL stays clean
      hiddenInput.remove();
    }
  });
</script>
